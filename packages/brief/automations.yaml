# automations.yaml
automation:
  - alias: "Morning Brief Trigger"
    description: "Triggers brief in the morning on weekdays"
    trigger:
      - platform: time
        at: "06:45:00"
    condition:
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
    action:
      - service: script.turn_on
        target:
          entity_id: script.daily_brief

  - alias: "Evening Brief Trigger"
    description: "Triggers brief in the evening"
    trigger:
      - platform: time
        at: "17:30:00"
    action:
      - service: script.turn_on
        target:
          entity_id: script.daily_brief

  - alias: "Calendar Update Brief Trigger"
    description: "Triggers brief when new events are about to start"
    trigger:
      platform: event
      event_type: calendar_event_start
      event_data: {}
    condition:
      - condition: template
        value_template: "{{ trigger.event.data.offset_reached == false }}"
      - condition: template
        value_template: "{{ trigger.event.data.offset == 1800 }}" # 30 minutes in seconds
    action:
      - service: script.turn_on
        target:
          entity_id: script.daily_brief

  - alias: "Significant Changes Brief Trigger"
    description: "Triggers brief on significant changes"
    trigger:
      # Device status changes
      - platform: event
        event_type: state_changed
        event_data:
          domain: device_tracker
      # Chore completion
      - platform: state
        entity_id:
          - input_boolean.chore_dishwasher_completed
          - input_boolean.chore_bathroom_completed
        to: "on"
      # Weather alerts
      - platform: state
        entity_id: weather.forecast_home
        attribute: weather_alert
    action:
      - service: script.turn_on
        target:
          entity_id: script.daily_brief

  - alias: "Handle Brief TTS Action"
    description: "Plays TTS on kitchen display when notification action is clicked"
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: PLAY_TTS
    action:
      - service: tts.speak
        target:
          entity_id: tts.google_en_com
        data:
          cache: true
          media_player_entity_id: media_player.kitchen_display
          message: "{{ trigger.event.data.data.detailed_brief }}"

  - alias: "Handle Brief Email Action"
    description: "Sends detailed brief via email when requested"
    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: EMAIL_BRIEF
    action:
      - service: logbook.log
        data:
          title: "Incoming Data"
          message: "{{ trigger.event.data }}"
      # - service: notify.bcl1713_gmail_com
      #   data:
      #     title: >
      #       {% set hour = now().hour %}
      #       {% if hour < 12 %}
      #         Morning Status Brief
      #       {% elif hour < 17 %}
      #         Afternoon Status Brief
      #       {% else %}
      #         Evening Status Brief
      #       {% endif %}
      #     message: "{{ trigger.event.data.data.detailed_brief }}"
